<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Busca de Médicos</title>
  <!-- hCaptcha -->
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
  <style>
    root {
      --fundo-claro: #f4f4f4;
      --fundo-escuro: #1c1c1c;
      --texto-claro: #e0e0e0;
      --fundo-cartao-claro: #fff;
      --fundo-cartao-escuro: #2a2a2a;
      --borda: #ccc;
      --borda-escura: #666;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: var(--fundo-claro);
      transition: background 0.3s, color 0.3s;
    }

    body.dark-mode {
      background: var(--fundo-escuro);
      color: var(--texto-claro);
    }

    .login-container, .main-content {
      max-width: 900px;
      margin: auto;
    }

    .login-container {
      margin-top: 100px;
      background: var(--fundo-cartao-claro);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .dark-mode .login-container {
      background: var(--fundo-cartao-escuro);
    }

    .login-container input {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .login-container button {
      width: 100%;
      padding: 10px;
      background: #007bff;
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    #darkModeToggle {
      margin: 10px 0;
      padding: 8px 16px;
      background: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .search-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .search-container input[type="text"] {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .search-container button {
      padding: 10px 20px;
      font-size: 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .filters {
      margin-bottom: 10px;
    }

    .filters button {
      background-color: #6c757d;
      margin: 5px 5px 5px 0;
      padding: 10px 15px;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .filters button.active {
      background-color: #28a745;
    }

    .results {
      margin-top: 20px;
    }

    .card {
      background: var(--fundo-cartao-claro);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .dark-mode .card {
      background: #333;
      color: var(--texto-claro);
    }

    .detalhes {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--borda);
      font-size: 14px;
    }

    .dark-mode .detalhes {
      border-top: 1px solid var(--borda-escura);
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</head>
<body>

<div class="login-container" id="loginContainer">
  <h2>Acesso Restrito</h2>
  <input type="text" id="login" placeholder="Login">
  <input type="password" id="senha" placeholder="Senha">
  <!-- hCaptcha -->
  <div class="h-captcha" data-sitekey="4e5c67ba-ca24-474e-b244-8520ab8efb32"></div>
  <button onclick="validarLogin()">Confirmar</button>
</div>

<div class="main-content" id="mainContent" style="display: none;">
  <h2>Busca de Médicos</h2>

  <button id="darkModeToggle" onclick="alternarModoEscuro()">Modo Escuro</button>
  <button id="gerarPdfBtn" onclick="gerarPDF()">Gerar PDF</button>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Digite nome ou CRM">
    <button onclick="buscar()">Buscar</button>
  </div>

  <div class="filters" id="filterButtons"></div>
  <div id="contadorResultados"></div>
  <div class="results" id="results"></div>
</div>

<script>
  const loginCorreto = "M&G2025";
  const senhaCorreta = "M&G@!2025QG";
  const apiURL = 'https://sheetdb.io/api/v1/cahitouo88zxm';
  let dados = [];
  let filtroAtual = 'Todos';

  const sinonimosHospitais = {
    "CEJAM": ["cejam", "cejan"],
    "AME CARAPICUIBA": ["ame carapicuiba", "carapicuiba"],
    "MBOI": ["mboi", "mbói", "mboi mirim"],
    "Tiradentes": ["tiradentes", "tiradêntes"],
    "ITAIM": ["itaim", "itáim"],
    "HGG": ["hgg", "hospital geral grajaú"],
    "HMB": ["hmb", "hospital municipal barreto"],
    "HGP": ["hgp", "hospital geral pirajussara"],
    "Pedreira": ["pedreira", "hospital pedreira"],
    "Ame dos Prados": ["ame dos prados", "dos prados"],
    "HMU": ["hmu", "hospital municipal de urgência"],
    "CHS": ["chs", "centro hospitalar sul"]
  };

  document.getElementById("senha").addEventListener("keypress", function(e) {
    if (e.key === "Enter") validarLogin();
  });

  document.getElementById("searchInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") buscar();
  });

  function alternarModoEscuro() {
    document.body.classList.toggle('dark-mode');
  }

  function validarLogin() {
    const login = document.getElementById("login").value;
    const senha = document.getElementById("senha").value;

    const hcaptchaResponse = hcaptcha.getResponse();

    if (!hcaptchaResponse) {
      alert("Por favor, verifique o hCaptcha.");
      return;
    }

    if (login === loginCorreto && senha === senhaCorreta) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      criarBotoesFiltro();
      buscarDados();
    } else {
      alert("Login ou senha incorretos.");
    }
  }

  function removerAcentos(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function normalizarHospital(hospital) {
    const chave = removerAcentos((hospital || "").toLowerCase().trim());
    for (const [padrao, sinonimos] of Object.entries(sinonimosHospitais)) {
      if (sinonimos.map(removerAcentos).includes(chave)) return padrao;
    }
    return hospital || '';
  }

  async function buscarDados() {
    try {
      const response = await fetch(apiURL);
      const json = await response.json();
      dados = json.map(p => ({ ...p, HospitalNormalizado: normalizarHospital(p["Hospital"]) }));
      renderizarResultados(dados);
    } catch (error) {
      alert("Erro ao buscar dados.");
      console.error(error);
    }
  }

  function buscar() {
    const termo = document.getElementById("searchInput").value.toLowerCase();
    const filtrado = dados.filter(p =>
      p["Nome"]?.toLowerCase().includes(termo) ||
      p["CRM"]?.toLowerCase().includes(termo)
    );
    const resultado = filtroAtual === 'Todos' ? filtrado : filtrado.filter(p => p.HospitalNormalizado === filtroAtual);
    renderizarResultados(resultado);
  }

  function filtrar(hospital) {
    filtroAtual = hospital;
    document.querySelectorAll(".filters button").forEach(btn => btn.classList.remove("active"));
    const botao = [...document.querySelectorAll(".filters button")].find(b => b.textContent === hospital);
    if (botao) botao.classList.add("active");
    buscar();
  }

  function renderizarResultados(lista) {
    const container = document.getElementById("results");
    const contador = document.getElementById("contadorResultados");
    contador.textContent = `${lista.length} resultado(s) encontrado(s).`;

    if (lista.length === 0) {
      container.innerHTML = "<p>Nenhum resultado encontrado.</p>";
      return;
    }

    container.innerHTML = lista.map(p => `
      <div class="card">
        <strong>Nome:</strong> ${p["Nome"] || 'N/A'}<br>
        <strong>CRM:</strong> ${p["CRM"] || 'N/A'}<br>
        <strong>Especialidade:</strong> ${p["Especialidade"] || 'N/A'}<br>
        <strong>Hospital:</strong> ${p["Hospital"] || 'N/A'}
        <div class="detalhes">
          <strong>IR:</strong> ${p["IR"] || 'N/A'}<br>
          <strong>Contrato:</strong> ${p["Contrato"] || 'N/A'}<br>
          <strong>CPF:</strong> ${p["CPF"] || 'N/A'}<br>
          <strong>RQE:</strong> ${p["RQE"] || 'N/A'}<br>
          <strong>Nome da Mãe:</strong> ${p["Nome da Mãe"] || 'N/A'}<br>
          <strong>Data de Nascimento:</strong> ${p["Data de Nascimento"] || 'N/A'}<br>
          <strong>PIX:</strong> ${p["PIX"] || 'N/A'}<br>
          <strong>Banco:</strong> ${p["Banco"] || 'N/A'}<br>
          <strong>Código do Banco:</strong> ${p["Codigo do Banco"] || 'N/A'}<br>
          <strong>Agência:</strong> ${p["Agência sem digito"] || 'N/A'}<br>
          <strong>Conta:</strong> ${p["Conta com o Dígito"] || 'N/A'}<br>
          <strong>Estado civil:</strong> ${p["Estado Civil"] || 'N/A'}<br>
          <strong>Naturalidade:</strong> ${p["Naturalidade"] || 'N/A'}<br>
          <strong>E-mail:</strong> ${p["E-mail"] || 'N/A'}<br>
          <strong>WhatsApp:</strong> ${p["Whatsapp"] || 'N/A'}<br>
          <strong>CEP:</strong> ${p["CEP"] || 'N/A'}<br>
          <strong>Endereço:</strong> ${p["Endereço"] || 'N/A'}
        </div>
      </div>
    `).join('');
  }

  function criarBotoesFiltro() {
    const container = document.getElementById("filterButtons");
    const blocos = ["Todos", ...Object.keys(sinonimosHospitais)];
    container.innerHTML = blocos.map(bloco => `
      <button onclick="filtrar('${bloco}')" class="${bloco === 'Todos' ? 'active' : ''}">${bloco}</button>
    `).join('');
  }
  
  function gerarPDF() {
  const resultados = document.getElementById("results");

  if (!resultados || resultados.innerHTML.trim() === "") {
    alert("Nenhum resultado para gerar PDF.");
    return;
  }

  const clone = resultados.cloneNode(true);
  clone.querySelectorAll('.detalhes').forEach(div => {
    div.style.display = 'block'; // Garante que os detalhes apareçam
  });

  const opt = {
    margin:       0.5,
    filename:     `medicos_resultado_${new Date().toISOString().slice(0,10)}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
  };

  html2pdf().from(clone).set(opt).save();
}

</script>

</body>
</html>
